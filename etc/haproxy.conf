global
    # Log to syslog
    log      localhost:514 local2
    
    # Max connections
    maxconn  1024
    
    # Number of processes
    nbproc 1

defaults
    # Use HTTP connections
    mode http
    
    # close HTTP keep-alives to make header analysis work across keep-alives
    option httpclose
    
    # Remove requests from the queue if people press stop button
    option abortonclose
    
    # Try to connect this many times on failure
    retries 3
    
    # If a client is bound to a particular backend but it goes down,
    # send them to a different one
    option redispatch
    
    # Expose a URL to make it easier to check if haproxy is up
    monitor-uri /_haproxy_ping_
    
    # Default timeouts
    timeout connect 7s
    timeout queue   300s
    timeout client  300s
    timeout server  300s
    
    # Enable status page at this URL, on the port HAProxy is bound to
    listen stats  localhost:8222
    stats enable
    stats uri /
    stats refresh 5s
    stats realm Haproxy statistics

# Default front-end
frontend loadbalancer
    
    # Bind to the given address
    bind localhost:8200
    
    # Log errors in HTTP logging format
    log    global
    option httplog
    option dontlog-normal
    
    # Access rules

    # Check for hostnames in request
    # acl default_cluster url_sub zope10.kreativkombinat.de
    # acl base_cluster hdr_beg(host) -i base.kreativkombinat.de
    acl base_cluster url_sub base.kreativkombinat.de
    acl gold_cluster url_sub evagold.de
    acl demo_cluster url_sub demo.kreativkombinat.de
    acl renaissance_cluster url_sub renaissance-interior-design.de
    acl wiretechnologies_cluster url_sub wiretechnologies.de
    acl girocom_cluster url_sub girocom.de
    acl putzteufel_cluster url_sub putzteufel-augsburg.de
    acl trainandmore_cluster url_sub trainandmore.com
    acl viyoma_cluster url_sub viyoma.de
    acl zwerge_cluster url_sub die-zwerge-live.de
    acl naturkost_cluster url_sub naturkost.kreativkombinat.de

    # Check that we have at least one node up in each cluster
    acl base_cluster_up nbsrv(base) gt 0
    acl gold_cluster_up nbsrv(gold) gt 0
    acl demo_cluster_up nbsrv(demo) gt 0
    acl renaissance_cluster_up nbsrv(renaissance) gt 0
    acl wiretechnologies_cluster_up nbsrv(wiretechnologies) gt 0
    acl girocom_cluster_up nbsrv(girocom) gt 0
    acl putzteufel_cluster_up nbsrv(putzteufel) gt 0
    acl trainandmore_cluster_up nbsrv(trainandmore) gt 0
    acl viyoma_cluster_up nbsrv(viyoma) gt 0
    acl zwerge_cluster_up nbsrv(zwerge) gt 0
    acl naturkost_cluster_up nbsrv(naturkost) gt 0

    # Routing
    use_backend base if base_cluster_up base_cluster
    use_backend gold if gold_cluster_up gold_cluster
    use_backend demo if demo_cluster_up demo_cluster
    use_backend renaissance if renaissance_cluster_up renaissance_cluster
    use_backend wiretechnologies if wiretechnologies_cluster_up wiretechnologies_cluster
    use_backend girocom if girocom_cluster_up girocom_cluster
    use_backend putzteufel if putzteufel_cluster_up putzteufel_cluster
    use_backend trainandmore if trainandmore_cluster_up trainandmore_cluster
    use_backend viyoma if viyoma_cluster_up viyoma_cluster
    use_backend zwerge if zwerge_cluster_up zwerge_cluster
    use_backend naturkost if naturkost_cluster_up naturkost_cluster
    
    default_backend panic

# Backend for all nodes.
backend base
    
    # Load balance based on number of connections
    balance leastconn
    
    # Record where we've been
    rspadd X-Cluster:\ default
    
    # Note: The maxconn values here match the ZServer thread count. This means requests pile up
    # in HAProxy until Zope's ready, instead of getting stuck in Zope.
    
    server base  127.0.0.1:8401 check rise 1 weight 50 maxconn 4

backend gold
    
    # Load balance based on number of connections
    balance leastconn
    
    # Record where we've been
    rspadd X-Cluster:\ default
    
    # Note: The maxconn values here match the ZServer thread count. This means requests pile up
    # in HAProxy until Zope's ready, instead of getting stuck in Zope.
    
    server gold  127.0.0.1:8402 check rise 1 weight 50 maxconn 4

backend demo
    
    # Load balance based on number of connections
    balance leastconn
    
    # Record where we've been
    rspadd X-Cluster:\ default
    
    # Note: The maxconn values here match the ZServer thread count. This means requests pile up
    # in HAProxy until Zope's ready, instead of getting stuck in Zope.
    
    server demo  127.0.0.1:8403 check rise 1 weight 50 maxconn 4

backend renaissance
    
    balance leastconn
    rspadd X-Cluster:\ default    
    server renaissance  127.0.0.1:8404 check rise 1 weight 50 maxconn 4

backend wiretechnologies
    
    balance leastconn
    rspadd X-Cluster:\ default    
    server wiretechnologies  127.0.0.1:8405 check rise 1 weight 50 maxconn 4

backend girocom
    
    balance leastconn
    rspadd X-Cluster:\ default    
    server girocom  127.0.0.1:8406 check rise 1 weight 50 maxconn 4

backend putzteufel
    
    balance leastconn
    rspadd X-Cluster:\ default    
    server putzteufel  127.0.0.1:8407 check rise 1 weight 50 maxconn 4

backend trainandmore
    
    balance leastconn
    rspadd X-Cluster:\ default    
    server trainandmore  127.0.0.1:8408 check rise 1 weight 50 maxconn 4

backend viyoma
    
    balance leastconn
    rspadd X-Cluster:\ default    
    server viyoma  127.0.0.1:8409 check rise 1 weight 50 maxconn 4

backend zwerge
    
    balance leastconn
    rspadd X-Cluster:\ default    
    server zwerge  127.0.0.1:8410 check rise 1 weight 50 maxconn 4

backend naturkost
    
    balance leastconn
    rspadd X-Cluster:\ default    
    server naturkost  127.0.0.1:8411 check rise 1 weight 50 maxconn 4


# This is hit only if none of the other clusters are working
backend panic
    
    balance leastconn
    
    # Panic!!!!111eleven!!
    redirect location /system-error drop-query
